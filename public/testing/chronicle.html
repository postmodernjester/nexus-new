<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chronicle</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #14141f;
    --surface2: #1e1e2e;
    --border: #2a2a3a;
    --text: #e0e0e8;
    --text-dim: #888;
    --accent: #6c63ff;
    --accent2: #ff6b6b;
    --work-color: #4a9eff;
    --project-color: #ff9f43;
    --personal-color: #ee5a24;
    --residence-color: #2ecc71;
    --tech-color: #a55eea;
    --people-color: #fd79a8;
    --geo-band-opacity: 0.06;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    overflow: hidden;
    height: 100vh;
  }

  /* Auth overlay */
  #auth-overlay {
    position: fixed; inset: 0; z-index: 9999;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 16px;
  }
  #auth-overlay h1 { font-size: 28px; color: var(--accent); }
  #auth-overlay p { color: var(--text-dim); margin-bottom: 12px; }
  #auth-overlay input {
    padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border);
    background: var(--surface); color: var(--text); font-size: 14px; width: 280px;
  }
  #auth-overlay button {
    padding: 10px 24px; border-radius: 8px; border: none;
    background: var(--accent); color: white; font-size: 14px; cursor: pointer;
  }
  #auth-overlay button:hover { opacity: 0.9; }
  #auth-error { color: var(--accent2); font-size: 13px; display: none; }

  /* Loading */
  #loading-overlay {
    position: fixed; inset: 0; z-index: 9998;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; color: var(--text-dim);
  }

  /* Header */
  #header {
    height: 48px; background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; position: relative; z-index: 100;
  }
  #header h1 { font-size: 16px; font-weight: 600; color: var(--accent); }
  #header-right { display: flex; align-items: center; gap: 12px; }
  #header-right button {
    padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border);
    background: var(--surface2); color: var(--text-dim); font-size: 12px; cursor: pointer;
  }
  #header-right button:hover { color: var(--text); border-color: var(--accent); }
  #save-status { font-size: 11px; color: var(--text-dim); }
  #user-email { font-size: 12px; color: var(--text-dim); }

  /* Main layout */
  #main {
    display: flex;
    height: calc(100vh - 48px);
  }

  /* Time axis */
  #time-axis {
    width: 80px; min-width: 80px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    position: relative; overflow: hidden;
  }
  .year-label {
    position: absolute; left: 0; width: 100%;
    text-align: center; font-size: 11px; color: var(--text-dim);
    pointer-events: none; transform: translateY(-50%);
  }
  .year-line {
    position: absolute; left: 60px; right: 0;
    border-top: 1px solid var(--border);
  }
  .decade-label { font-weight: 700; color: var(--text); font-size: 12px; }

  /* Columns container */
  #columns-container {
    flex: 1; display: flex; overflow-x: auto; position: relative;
  }

  /* Geography bands */
  .geo-band {
    position: absolute; left: 0; right: 0;
    pointer-events: none; z-index: 0;
    display: flex; align-items: center; justify-content: flex-end;
    padding-right: 8px;
  }
  .geo-band-label {
    font-size: 10px; color: rgba(255,255,255,0.15);
    text-transform: uppercase; letter-spacing: 1px;
    writing-mode: horizontal-tb;
  }

  /* Column */
  .column {
    flex: 1; min-width: 180px;
    border-right: 1px solid var(--border);
    position: relative; overflow: hidden;
  }
  .column-header {
    height: 32px; display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 1px; border-bottom: 1px solid var(--border);
    background: var(--surface); position: relative; z-index: 10;
    cursor: pointer;
  }
  .column-header .add-btn {
    position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
    width: 20px; height: 20px; border-radius: 50%;
    border: 1px solid var(--border); background: transparent;
    color: var(--text-dim); font-size: 14px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    line-height: 1;
  }
  .column-header .add-btn:hover { border-color: var(--accent); color: var(--accent); }
  .column-body {
    position: relative;
    height: calc(100% - 32px);
    overflow: hidden;
  }

  /* Entries */
  .entry {
    position: absolute;
    left: 8px; right: 8px;
    border-radius: 6px;
    padding: 6px 8px;
    font-size: 11px;
    cursor: pointer;
    border-left: 3px solid;
    transition: box-shadow 0.15s;
    overflow: hidden;
    z-index: 5;
  }
  .entry:hover {
    box-shadow: 0 0 12px rgba(108, 99, 255, 0.3);
    z-index: 10;
  }
  .entry-title {
    font-weight: 600; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis;
    line-height: 1.3;
  }
  .entry-sub {
    font-size: 10px; color: var(--text-dim);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    margin-top: 1px;
    line-height: 1.3;
  }
  .entry-dates {
    font-size: 9px; color: var(--text-dim);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    margin-top: 1px; opacity: 0.7;
  }
  .entry-desc {
    font-size: 9px; color: var(--text-dim);
    margin-top: 3px; line-height: 1.3;
    overflow: hidden; display: -webkit-box;
    -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  }
  /* Zoom-level classes applied to columns-container */
  .zoom-micro .entry-sub,
  .zoom-micro .entry-dates,
  .zoom-micro .entry-desc { display: none !important; }
  .zoom-micro .entry-title { font-size: 9px; }
  .zoom-micro .entry { padding: 2px 4px; min-height: 14px; }

  .zoom-compact .entry-dates,
  .zoom-compact .entry-desc { display: none !important; }
  .zoom-compact .entry-title { font-size: 10px; }
  .zoom-compact .entry-sub { font-size: 9px; }
  .zoom-compact .entry { padding: 3px 6px; }

  .zoom-normal .entry-desc { display: none !important; }

  .zoom-detailed .entry-desc { display: -webkit-box !important; }
  .entry-resize-handle {
    position: absolute; bottom: 0; left: 0; right: 0;
    height: 6px; cursor: ns-resize;
  }

  /* Hover tooltip */
  #tooltip {
    position: fixed; z-index: 1000;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 14px;
    font-size: 12px; max-width: 280px;
    pointer-events: none; display: none;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  }
  #tooltip .tt-title { font-weight: 700; font-size: 13px; margin-bottom: 4px; }
  #tooltip .tt-sub { color: var(--text-dim); font-size: 11px; }
  #tooltip .tt-desc { margin-top: 6px; font-size: 11px; color: var(--text-dim); line-height: 1.4; }

  /* Modal */
  #modal-overlay {
    position: fixed; inset: 0; z-index: 500;
    background: rgba(0,0,0,0.6);
    display: none; align-items: center; justify-content: center;
  }
  #modal {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 24px; width: 400px; max-width: 90vw;
  }
  #modal h2 { font-size: 16px; margin-bottom: 16px; }
  .modal-field { margin-bottom: 12px; }
  .modal-field label { display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 4px; }
  .modal-field input, .modal-field textarea, .modal-field select {
    width: 100%; padding: 8px 12px; border-radius: 6px;
    border: 1px solid var(--border); background: var(--surface2);
    color: var(--text); font-size: 13px; font-family: inherit;
  }
  .modal-field textarea { height: 60px; resize: vertical; }
  .modal-buttons { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
  .modal-buttons button {
    padding: 8px 16px; border-radius: 6px; border: none;
    font-size: 13px; cursor: pointer;
  }
  .btn-save { background: var(--accent); color: white; }
  .btn-cancel { background: var(--surface2); color: var(--text-dim); border: 1px solid var(--border) !important; }
  .btn-delete { background: var(--accent2); color: white; }
  .btn-save:hover, .btn-delete:hover { opacity: 0.9; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<!-- Auth Overlay -->
<div id="auth-overlay">
  <h1>Chronicle</h1>
  <p>Sign in to your NEXUS account</p>
  <input type="email" id="auth-email" placeholder="Email" />
  <input type="password" id="auth-password" placeholder="Password" />
  <div id="auth-error"></div>
  <button id="auth-submit">Sign In</button>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" style="display:none;">
  Loading your timeline...
</div>

<!-- Header -->
<div id="header" style="display:none;">
  <h1>Chronicle</h1>
  <div id="header-right">
    <span id="save-status"></span>
    <button id="btn-add-place" title="Add geography band">+ Place</button>
    <span id="user-email"></span>
    <button id="btn-logout">Logout</button>
  </div>
</div>

<!-- Main -->
<div id="main" style="display:none;">
  <div id="time-axis"></div>
  <div id="columns-container">
    <div class="column" data-cat="work">
      <div class="column-header" style="color:var(--work-color)">Work <button class="add-btn">+</button></div>
      <div class="column-body"></div>
    </div>
    <div class="column" data-cat="project">
      <div class="column-header" style="color:var(--project-color)">Projects <button class="add-btn">+</button></div>
      <div class="column-body"></div>
    </div>
    <div class="column" data-cat="personal">
      <div class="column-header" style="color:var(--personal-color)">Personal <button class="add-btn">+</button></div>
      <div class="column-body"></div>
    </div>
    <div class="column" data-cat="residence">
      <div class="column-header" style="color:var(--residence-color)">Residences <button class="add-btn">+</button></div>
      <div class="column-body"></div>
    </div>
    <div class="column" data-cat="tech">
      <div class="column-header" style="color:var(--tech-color)">Tech <button class="add-btn">+</button></div>
      <div class="column-body"></div>
    </div>
    <div class="column" data-cat="people">
      <div class="column-header" style="color:var(--people-color)">People <button class="add-btn">+</button></div>
      <div class="column-body"></div>
    </div>
  </div>
</div>

<!-- Tooltip -->
<div id="tooltip">
  <div class="tt-title"></div>
  <div class="tt-sub"></div>
  <div class="tt-desc"></div>
</div>

<!-- Modal -->
<div id="modal-overlay">
  <div id="modal">
    <h2 id="modal-title">Add Entry</h2>
    <div class="modal-field">
      <label>Title / Name</label>
      <input type="text" id="m-title" placeholder="e.g. Senior Developer" />
    </div>
    <div class="modal-field">
      <label>Subtitle / Company / Role</label>
      <input type="text" id="m-subtitle" placeholder="e.g. Google" />
    </div>
    <div class="modal-field" id="m-location-field">
      <label>Location</label>
      <input type="text" id="m-location" placeholder="e.g. San Francisco, CA" />
    </div>
    <div class="modal-field">
      <label>Start Date</label>
      <input type="month" id="m-start" />
    </div>
    <div class="modal-field">
      <label>End Date (leave blank for ongoing)</label>
      <input type="month" id="m-end" />
    </div>
    <div class="modal-field">
      <label>Description / Notes</label>
      <textarea id="m-desc"></textarea>
    </div>
    <div class="modal-field" id="m-color-field" style="display:none;">
      <label>Band Color</label>
      <input type="color" id="m-color" value="#334455" />
    </div>
    <div class="modal-buttons">
      <button class="btn-delete" id="m-delete" style="display:none;">Delete</button>
      <div style="flex:1"></div>
      <button class="btn-cancel" id="m-cancel">Cancel</button>
      <button class="btn-save" id="m-save">Save</button>
    </div>
  </div>
</div>

<script>
// ============ CONFIG ============
const SUPABASE_URL = 'https://wzopfeeivypifdfaxrsg.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6b3BmZWVpdnlwaWZkZmF4cnNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTYxMjQsImV4cCI6MjA4NjczMjEyNH0.sGebtrGrhOM6SLgw0lwM0CdH1HERiwyQxpdNM3OE28A';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const COLORS = {
  work: { bg: 'rgba(74,158,255,0.12)', border: '#4a9eff' },
  project: { bg: 'rgba(255,159,67,0.12)', border: '#ff9f43' },
  personal: { bg: 'rgba(238,90,36,0.12)', border: '#ee5a24' },
  residence: { bg: 'rgba(46,204,113,0.12)', border: '#2ecc71' },
  tech: { bg: 'rgba(165,94,234,0.12)', border: '#a55eea' },
  people: { bg: 'rgba(253,121,168,0.12)', border: '#fd79a8' },
};

const GEO_COLORS = [
  'rgba(74,158,255,VAR)', 'rgba(46,204,113,VAR)', 'rgba(255,159,67,VAR)',
  'rgba(165,94,234,VAR)', 'rgba(253,121,168,VAR)', 'rgba(238,90,36,VAR)',
  'rgba(108,99,255,VAR)', 'rgba(0,206,209,VAR)'
];

let PIXELS_PER_YEAR = 80;
let currentUser = null;
let birthYear = 1990;
let entries = [];
let places = [];
let scrollOffset = 0;
let editingEntry = null;
let editingPlace = false;
let modalCategory = null;
let saveTimeout = null;

// ============ AUTH ============
const authOverlay = document.getElementById('auth-overlay');
const loadingOverlay = document.getElementById('loading-overlay');
const header = document.getElementById('header');
const main = document.getElementById('main');

document.getElementById('auth-submit').addEventListener('click', doLogin);
document.getElementById('auth-password').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

async function doLogin() {
  const email = document.getElementById('auth-email').value.trim();
  const pw = document.getElementById('auth-password').value;
  const errEl = document.getElementById('auth-error');
  errEl.style.display = 'none';
  if (!email || !pw) { errEl.textContent = 'Enter email and password'; errEl.style.display = 'block'; return; }
  const { data, error } = await sb.auth.signInWithPassword({ email, password: pw });
  if (error) { errEl.textContent = error.message; errEl.style.display = 'block'; return; }
  currentUser = data.user;
  startApp();
}

async function checkSession() {
  const { data } = await sb.auth.getSession();
  if (data.session) {
    currentUser = data.session.user;
    startApp();
  }
}

document.getElementById('btn-logout').addEventListener('click', async () => {
  await sb.auth.signOut();
  location.reload();
});

async function startApp() {
  authOverlay.style.display = 'none';
  loadingOverlay.style.display = 'flex';
  await loadProfile();
  await loadData();
  loadingOverlay.style.display = 'none';
  header.style.display = 'flex';
  main.style.display = 'flex';
  document.getElementById('user-email').textContent = currentUser.email;
  render();
}

// ============ PROFILE / BIRTH YEAR ============
async function loadProfile() {
  const { data } = await sb.from('profiles').select('birth_year').eq('id', currentUser.id).single();
  if (data && data.birth_year) {
    birthYear = data.birth_year;
  }
}

// ============ LOAD DATA ============
async function loadData() {
  entries = [];
  places = [];

  // Load chronicle_entries (projects, personal, residence, tech)
  const { data: ceData } = await sb.from('chronicle_entries')
    .select('*')
    .eq('user_id', currentUser.id);

  if (ceData) {
    for (const row of ceData) {
      entries.push({
        id: genId(),
        category: row.entry_type,
        title: row.title,
        subtitle: row.subtitle || '',
        location: row.location || '',
        start_y: row.start_year,
        start_m: row.start_month || 1,
        end_y: row.end_year || null,
        end_m: row.end_month || null,
        description: row.description || '',
        supabase_id: row.id,
        source: 'chronicle',
        linked_id: null,
      });
    }
  }

  // Load work_entries → work column
  const { data: weData } = await sb.from('work_entries')
    .select('*')
    .eq('user_id', currentUser.id);

  if (weData) {
    for (const row of weData) {
      const sd = row.start_date ? new Date(row.start_date) : null;
      const ed = row.end_date ? new Date(row.end_date) : null;
      entries.push({
        id: genId(),
        category: 'work',
        title: row.title || '',
        subtitle: row.company || '',
        location: row.location || '',
        start_y: sd ? sd.getFullYear() : 2020,
        start_m: sd ? sd.getMonth() + 1 : 1,
        end_y: ed ? ed.getFullYear() : null,
        end_m: ed ? ed.getMonth() + 1 : null,
        description: row.description || '',
        supabase_id: row.id,
        source: 'work_entries',
        linked_id: null,
      });
    }
  }

  // Load contacts → people column
  const { data: cData } = await sb.from('contacts')
    .select('*')
    .eq('owner_id', currentUser.id);

  if (cData) {
    for (const row of cData) {
      const md = row.met_date ? new Date(row.met_date) : null;
      entries.push({
        id: genId(),
        category: 'people',
        title: row.full_name || '',
        subtitle: [row.role, row.company].filter(Boolean).join(' @ '),
        location: row.location || '',
        start_y: md ? md.getFullYear() : null,
        start_m: md ? md.getMonth() + 1 : null,
        end_y: null,
        end_m: null,
        description: row.how_we_met || '',
        supabase_id: row.id,
        source: 'contacts',
        linked_id: null,
      });
    }
  }

  // Load places
  const { data: pData } = await sb.from('chronicle_places')
    .select('*')
    .eq('user_id', currentUser.id);

  if (pData) {
    for (const row of pData) {
      places.push({
        id: genId(),
        name: row.name,
        start_y: row.start_year,
        start_m: row.start_month || 1,
        end_y: row.end_year || null,
        end_m: row.end_month || null,
        color: row.color || GEO_COLORS[places.length % GEO_COLORS.length].replace('VAR', '0.06'),
        supabase_id: row.id,
      });
    }
  }
}

// ============ SAVE HELPERS ============
function showSaveStatus(msg) {
  const el = document.getElementById('save-status');
  el.textContent = msg;
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => { el.textContent = ''; }, 2000);
}

async function saveEntry(entry) {
  showSaveStatus('Saving...');
  try {
    if (entry.category === 'work') {
      await saveWorkEntry(entry);
    } else if (entry.category === 'people') {
      await saveContactEntry(entry);
    } else {
      await saveChronicleEntry(entry);
    }
    showSaveStatus('✓ Saved');
  } catch (e) {
    console.error('Save error', e);
    showSaveStatus('✗ Save failed');
  }
}

async function saveWorkEntry(entry) {
  const payload = {
    user_id: currentUser.id,
    title: entry.title,
    company: entry.subtitle,
    location: entry.location || null,
    start_date: entry.start_y ? `${entry.start_y}-${String(entry.start_m||1).padStart(2,'0')}-01` : null,
    end_date: entry.end_y ? `${entry.end_y}-${String(entry.end_m||1).padStart(2,'0')}-01` : null,
    is_current: !entry.end_y,
    description: entry.description || null,
  };
  if (entry.supabase_id && entry.source === 'work_entries') {
    const { error } = await sb.from('work_entries').update(payload).eq('id', entry.supabase_id);
    if (error) throw error;
  } else {
    const { data, error } = await sb.from('work_entries').insert(payload).select().single();
    if (error) throw error;
    entry.supabase_id = data.id;
    entry.source = 'work_entries';
  }
}

async function saveContactEntry(entry) {
  let role = '', company = '';
  if (entry.subtitle && entry.subtitle.includes('@')) {
    const parts = entry.subtitle.split('@').map(s => s.trim());
    role = parts[0] || '';
    company = parts[1] || '';
  } else {
    company = entry.subtitle || '';
  }
  const payload = {
    owner_id: currentUser.id,
    full_name: entry.title,
    role: role || null,
    company: company || null,
    location: entry.location || null,
    met_date: entry.start_y ? `${entry.start_y}-${String(entry.start_m||1).padStart(2,'0')}-01` : null,
    how_we_met: entry.description || null,
  };
  if (entry.supabase_id && entry.source === 'contacts') {
    const { error } = await sb.from('contacts').update(payload).eq('id', entry.supabase_id);
    if (error) throw error;
  } else {
    const { data, error } = await sb.from('contacts').insert(payload).select().single();
    if (error) throw error;
    entry.supabase_id = data.id;
    entry.source = 'contacts';
  }
}

async function saveChronicleEntry(entry) {
  const payload = {
    user_id: currentUser.id,
    entry_type: entry.category,
    title: entry.title,
    subtitle: entry.subtitle || null,
    location: entry.location || null,
    start_year: entry.start_y,
    start_month: entry.start_m || null,
    end_year: entry.end_y || null,
    end_month: entry.end_m || null,
    description: entry.description || null,
  };
  if (entry.supabase_id && entry.source === 'chronicle') {
    const { error } = await sb.from('chronicle_entries').update(payload).eq('id', entry.supabase_id);
    if (error) throw error;
  } else {
    const { data, error } = await sb.from('chronicle_entries').insert(payload).select().single();
    if (error) throw error;
    entry.supabase_id = data.id;
    entry.source = 'chronicle';
  }
}

async function deleteEntryFromDB(entry) {
  showSaveStatus('Deleting...');
  try {
    if (entry.source === 'work_entries') {
      await sb.from('work_entries').delete().eq('id', entry.supabase_id);
    } else if (entry.source === 'contacts') {
      await sb.from('contacts').delete().eq('id', entry.supabase_id);
    } else if (entry.source === 'chronicle') {
      await sb.from('chronicle_entries').delete().eq('id', entry.supabase_id);
    }
    showSaveStatus('✓ Deleted');
  } catch (e) {
    console.error('Delete error', e);
    showSaveStatus('✗ Delete failed');
  }
}

async function savePlace(place) {
  showSaveStatus('Saving...');
  try {
    const payload = {
      user_id: currentUser.id,
      name: place.name,
      start_year: place.start_y,
      start_month: place.start_m || null,
      end_year: place.end_y || null,
      end_month: place.end_m || null,
      color: place.color || null,
    };
    if (place.supabase_id) {
      await sb.from('chronicle_places').update(payload).eq('id', place.supabase_id);
    } else {
      const { data, error } = await sb.from('chronicle_places').insert(payload).select().single();
      if (error) throw error;
      place.supabase_id = data.id;
    }
    showSaveStatus('✓ Saved');
  } catch (e) {
    console.error('Save place error', e);
    showSaveStatus('✗ Save failed');
  }
}

async function deletePlaceFromDB(place) {
  if (!place.supabase_id) return;
  showSaveStatus('Deleting...');
  try {
    await sb.from('chronicle_places').delete().eq('id', place.supabase_id);
    showSaveStatus('✓ Deleted');
  } catch (e) {
    showSaveStatus('✗ Delete failed');
  }
}

// ============ RENDER ============
function yearToY(year, month) {
  month = month || 1;
  const fractional = year + (month - 1) / 12;
  return (fractional - birthYear) * PIXELS_PER_YEAR + scrollOffset;
}

function yToYear(y) {
  const fractional = (y - scrollOffset) / PIXELS_PER_YEAR + birthYear;
  const year = Math.floor(fractional);
  const month = Math.round((fractional - year) * 12) + 1;
  return { year, month: Math.max(1, Math.min(12, month)) };
}

function updateZoomClass() {
  const container = document.getElementById('columns-container');
  container.classList.remove('zoom-micro', 'zoom-compact', 'zoom-normal', 'zoom-detailed');
  if (PIXELS_PER_YEAR <= 30) {
    container.classList.add('zoom-micro');
  } else if (PIXELS_PER_YEAR <= 55) {
    container.classList.add('zoom-compact');
  } else if (PIXELS_PER_YEAR <= 120) {
    container.classList.add('zoom-normal');
  } else {
    container.classList.add('zoom-detailed');
  }
}

function render() {
  updateZoomClass();
  renderTimeAxis();
  renderGeoBands();
  renderEntries();
}

function renderTimeAxis() {
  const axis = document.getElementById('time-axis');
  axis.innerHTML = '';
  const h = axis.parentElement.clientHeight;
  const startY = birthYear;
  const now = new Date().getFullYear();
  const endY = now + 2;

  for (let y = startY; y <= endY; y++) {
    const top = yearToY(y, 1);
    if (top < -30 || top > h + 30) continue;
    const label = document.createElement('div');
    label.className = 'year-label' + (y % 10 === 0 ? ' decade-label' : '');
    label.textContent = y;
    label.style.top = top + 'px';
    axis.appendChild(label);

    const line = document.createElement('div');
    line.className = 'year-line';
    line.style.top = top + 'px';
    axis.appendChild(line);
  }
}

function renderGeoBands() {
  document.querySelectorAll('.geo-band').forEach(el => el.remove());
  const container = document.getElementById('columns-container');
  const h = container.clientHeight;

  for (let i = 0; i < places.length; i++) {
    const p = places[i];
    const top = yearToY(p.start_y, p.start_m);
    const now = new Date();
    const endY = p.end_y || now.getFullYear();
    const endM = p.end_m || now.getMonth() + 1;
    const bot = yearToY(endY, endM);
    if (bot < 0 || top > h) continue;

    const band = document.createElement('div');
    band.className = 'geo-band';
    band.style.top = Math.max(0, top) + 'px';
    band.style.height = Math.max(0, bot - Math.max(0, top)) + 'px';
    const col = p.color || GEO_COLORS[i % GEO_COLORS.length].replace('VAR', '0.06');
    band.style.background = col;
    band.innerHTML = `<span class="geo-band-label">${p.name}</span>`;
    band.style.cursor = 'pointer';
    band.addEventListener('dblclick', () => openPlaceModal(p));
    container.insertBefore(band, container.firstChild);
  }
}

function renderEntries() {
  document.querySelectorAll('.column-body').forEach(body => {
    body.innerHTML = '';
  });

  const now = new Date();
  const nowY = now.getFullYear();
  const nowM = now.getMonth() + 1;

  for (const entry of entries) {
    if (!entry.start_y) continue;
    const col = document.querySelector(`.column[data-cat="${entry.category}"] .column-body`);
    if (!col) continue;

    const top = yearToY(entry.start_y, entry.start_m);
    const endYr = entry.end_y || nowY;
    const endMo = entry.end_m || nowM;
    const bot = yearToY(endYr, endMo);
    const height = Math.max(20, bot - top);

    const el = document.createElement('div');
    el.className = 'entry';
    el.style.top = top + 'px';
    el.style.height = height + 'px';
    el.style.background = COLORS[entry.category].bg;
    el.style.borderLeftColor = COLORS[entry.category].border;

    // Date string for detail view
    let dateStr = '';
    if (entry.start_y) {
      dateStr = `${entry.start_m || ''}/${entry.start_y}`;
      if (entry.end_y) dateStr += ` – ${entry.end_m || ''}/${entry.end_y}`;
      else dateStr += ' – present';
    }

    el.innerHTML = `
      <div class="entry-title">${esc(entry.title)}</div>
      ${entry.subtitle ? `<div class="entry-sub">${esc(entry.subtitle)}</div>` : ''}
      ${dateStr ? `<div class="entry-dates">${dateStr}</div>` : ''}
      ${entry.description ? `<div class="entry-desc">${esc(entry.description)}</div>` : ''}
      <div class="entry-resize-handle"></div>
    `;

    el.addEventListener('mouseenter', e => showTooltip(e, entry));
    el.addEventListener('mousemove', e => moveTooltip(e));
    el.addEventListener('mouseleave', hideTooltip);
    el.addEventListener('dblclick', () => openEditModal(entry));
    makeDraggable(el, entry);
    makeResizable(el.querySelector('.entry-resize-handle'), entry);

    col.appendChild(el);
  }

  // People without dates rendered at top
  const peoplNoDate = entries.filter(e => e.category === 'people' && !e.start_y);
  if (peoplNoDate.length > 0) {
    const col = document.querySelector('.column[data-cat="people"] .column-body');
    let topOffset = 4;
    for (const entry of peoplNoDate) {
      const el = document.createElement('div');
      el.className = 'entry';
      el.style.top = topOffset + 'px';
      el.style.height = '28px';
      el.style.background = COLORS.people.bg;
      el.style.borderLeftColor = COLORS.people.border;
      el.style.opacity = '0.6';
      el.innerHTML = `<div class="entry-title">${esc(entry.title)}</div>`;
      el.addEventListener('dblclick', () => openEditModal(entry));
      el.addEventListener('mouseenter', e => showTooltip(e, entry));
      el.addEventListener('mousemove', e => moveTooltip(e));
      el.addEventListener('mouseleave', hideTooltip);
      col.appendChild(el);
      topOffset += 32;
    }
  }
}

// ============ TOOLTIP ============
const tooltipEl = document.getElementById('tooltip');
function showTooltip(e, entry) {
  let dateStr = '';
  if (entry.start_y) {
    dateStr = `${entry.start_m || ''}/${entry.start_y}`;
    if (entry.end_y) dateStr += ` – ${entry.end_m || ''}/${entry.end_y}`;
    else dateStr += ' – present';
  }
  tooltipEl.querySelector('.tt-title').textContent = entry.title;
  tooltipEl.querySelector('.tt-sub').textContent = [entry.subtitle, entry.location, dateStr].filter(Boolean).join(' · ');
  tooltipEl.querySelector('.tt-desc').textContent = entry.description || '';
  tooltipEl.style.display = 'block';
  moveTooltip(e);
}
function moveTooltip(e) {
  tooltipEl.style.left = (e.clientX + 14) + 'px';
  tooltipEl.style.top = (e.clientY + 14) + 'px';
}
function hideTooltip() { tooltipEl.style.display = 'none'; }

// ============ DRAG & RESIZE ============
function makeDraggable(el, entry) {
  let startMouseY, startTop;
  el.addEventListener('mousedown', e => {
    if (e.target.classList.contains('entry-resize-handle')) return;
    e.preventDefault();
    startMouseY = e.clientY;
    startTop = parseFloat(el.style.top);
    const onMove = ev => {
      const dy = ev.clientY - startMouseY;
      el.style.top = (startTop + dy) + 'px';
    };
    const onUp = ev => {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      const newTop = parseFloat(el.style.top);
      const { year, month } = yToYear(newTop);
      const duration = (entry.end_y && entry.end_m) ?
        ((entry.end_y + entry.end_m / 12) - (entry.start_y + entry.start_m / 12)) : 0;
      entry.start_y = year;
      entry.start_m = month;
      if (entry.end_y) {
        const newEnd = year + (month - 1) / 12 + duration;
        entry.end_y = Math.floor(newEnd);
        entry.end_m = Math.round((newEnd - entry.end_y) * 12) + 1;
      }
      saveEntry(entry);
      render();
    };
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
}

function makeResizable(handle, entry) {
  let startMouseY, startH;
  handle.addEventListener('mousedown', e => {
    e.preventDefault();
    e.stopPropagation();
    const el = handle.parentElement;
    startMouseY = e.clientY;
    startH = parseFloat(el.style.height);
    const onMove = ev => {
      const dy = ev.clientY - startMouseY;
      el.style.height = Math.max(20, startH + dy) + 'px';
    };
    const onUp = ev => {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      const el2 = handle.parentElement;
      const newBot = parseFloat(el2.style.top) + parseFloat(el2.style.height);
      const { year, month } = yToYear(newBot);
      entry.end_y = year;
      entry.end_m = month;
      saveEntry(entry);
      render();
    };
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
}

// ============ MODAL ============
const modalOverlay = document.getElementById('modal-overlay');

function openAddModal(category) {
  editingEntry = null;
  editingPlace = false;
  modalCategory = category;
  document.getElementById('modal-title').textContent = 'Add ' + category.charAt(0).toUpperCase() + category.slice(1);
  document.getElementById('m-title').value = '';
  document.getElementById('m-subtitle').value = '';
  document.getElementById('m-location').value = '';
  document.getElementById('m-start').value = '';
  document.getElementById('m-end').value = '';
  document.getElementById('m-desc').value = '';
  document.getElementById('m-delete').style.display = 'none';
  document.getElementById('m-color-field').style.display = 'none';
  document.getElementById('m-location-field').style.display = 'block';
  updateModalLabels(category);
  modalOverlay.style.display = 'flex';
}

function openEditModal(entry) {
  editingEntry = entry;
  editingPlace = false;
  modalCategory = entry.category;
  document.getElementById('modal-title').textContent = 'Edit ' + entry.category.charAt(0).toUpperCase() + entry.category.slice(1);
  document.getElementById('m-title').value = entry.title || '';
  document.getElementById('m-subtitle').value = entry.subtitle || '';
  document.getElementById('m-location').value = entry.location || '';
  document.getElementById('m-start').value = entry.start_y ? `${entry.start_y}-${String(entry.start_m||1).padStart(2,'0')}` : '';
  document.getElementById('m-end').value = entry.end_y ? `${entry.end_y}-${String(entry.end_m||1).padStart(2,'0')}` : '';
  document.getElementById('m-desc').value = entry.description || '';
  document.getElementById('m-delete').style.display = 'inline-block';
  document.getElementById('m-color-field').style.display = 'none';
  document.getElementById('m-location-field').style.display = 'block';
  updateModalLabels(entry.category);
  modalOverlay.style.display = 'flex';
}

function openPlaceModal(place) {
  editingEntry = place || null;
  editingPlace = true;
  modalCategory = 'place';
  document.getElementById('modal-title').textContent = place ? 'Edit Place' : 'Add Place';
  document.getElementById('m-title').value = place ? place.name : '';
  document.getElementById('m-subtitle').value = '';
  document.getElementById('m-location').value = '';
  document.getElementById('m-start').value = place && place.start_y ? `${place.start_y}-${String(place.start_m||1).padStart(2,'0')}` : '';
  document.getElementById('m-end').value = place && place.end_y ? `${place.end_y}-${String(place.end_m||1).padStart(2,'0')}` : '';
  document.getElementById('m-desc').value = '';
  document.getElementById('m-delete').style.display = place ? 'inline-block' : 'none';
  document.getElementById('m-color-field').style.display = 'block';
  document.getElementById('m-color').value = place ? (place.color ? rgbaToHex(place.color) : '#334455') : '#334455';
  document.getElementById('m-location-field').style.display = 'none';
  document.querySelector('#m-subtitle').parentElement.style.display = 'none';
  document.querySelector('#m-desc').parentElement.style.display = 'none';
  modalOverlay.style.display = 'flex';
}

function updateModalLabels(cat) {
  const titleLabel = document.querySelector('#m-title').previousElementSibling;
  const subLabel = document.querySelector('#m-subtitle').previousElementSibling;
  const locLabel = document.querySelector('#m-location').previousElementSibling;
  const descLabel = document.querySelector('#m-desc').previousElementSibling;
  const subField = document.querySelector('#m-subtitle').parentElement;
  const locField = document.querySelector('#m-location').parentElement;
  const descField = document.querySelector('#m-desc').parentElement;

  subField.style.display = 'block';
  locField.style.display = 'block';
  descField.style.display = 'block';

  switch (cat) {
    case 'work':
      titleLabel.textContent = 'Job Title';
      subLabel.textContent = 'Company';
      locLabel.textContent = 'Location';
      descLabel.textContent = 'Description';
      break;
    case 'project':
      titleLabel.textContent = 'Project Name';
      subLabel.textContent = 'Context / Client';
      locLabel.textContent = 'Location (optional)';
      descLabel.textContent = 'Description';
      break;
    case 'personal':
      titleLabel.textContent = 'Event / Milestone';
      subLabel.textContent = 'Details';
      locLabel.textContent = 'Location (optional)';
      descLabel.textContent = 'Notes';
      break;
    case 'residence':
      titleLabel.textContent = 'Place Name';
      subLabel.textContent = 'Address / Area';
      locLabel.textContent = 'City, State';
      descLabel.textContent = 'Notes';
      break;
    case 'tech':
      titleLabel.textContent = 'Technology / Skill';
      subLabel.textContent = 'Category (language, tool, etc.)';
      locField.style.display = 'none';
      descLabel.textContent = 'Notes';
      break;
    case 'people':
      titleLabel.textContent = 'Full Name';
      subLabel.textContent = 'Role @ Company';
      locLabel.textContent = 'Location';
      descLabel.textContent = 'How you met / Notes';
      break;
  }
}

function closeModal() {
  modalOverlay.style.display = 'none';
  editingEntry = null;
  editingPlace = false;
  modalCategory = null;
  document.querySelector('#m-subtitle').parentElement.style.display = 'block';
  document.querySelector('#m-desc').parentElement.style.display = 'block';
}

document.getElementById('m-cancel').addEventListener('click', closeModal);
modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeModal(); });

document.getElementById('m-save').addEventListener('click', async () => {
  const title = document.getElementById('m-title').value.trim();
  if (!title) return;

  if (editingPlace) {
    const startVal = document.getElementById('m-start').value;
    const endVal = document.getElementById('m-end').value;
    const colorHex = document.getElementById('m-color').value;
    const color = hexToRgba(colorHex, 0.06);

    if (editingEntry) {
      editingEntry.name = title;
      if (startVal) { editingEntry.start_y = parseInt(startVal.split('-')[0]); editingEntry.start_m = parseInt(startVal.split('-')[1]); }
      if (endVal) { editingEntry.end_y = parseInt(endVal.split('-')[0]); editingEntry.end_m = parseInt(endVal.split('-')[1]); }
      else { editingEntry.end_y = null; editingEntry.end_m = null; }
      editingEntry.color = color;
      await savePlace(editingEntry);
    } else {
      const place = {
        id: genId(),
        name: title,
        start_y: startVal ? parseInt(startVal.split('-')[0]) : new Date().getFullYear(),
        start_m: startVal ? parseInt(startVal.split('-')[1]) : 1,
        end_y: endVal ? parseInt(endVal.split('-')[0]) : null,
        end_m: endVal ? parseInt(endVal.split('-')[1]) : null,
        color: color,
        supabase_id: null,
      };
      places.push(place);
      await savePlace(place);
    }
  } else {
    const subtitle = document.getElementById('m-subtitle').value.trim();
    const location = document.getElementById('m-location').value.trim();
    const startVal = document.getElementById('m-start').value;
    const endVal = document.getElementById('m-end').value;
    const desc = document.getElementById('m-desc').value.trim();

    if (editingEntry) {
      editingEntry.title = title;
      editingEntry.subtitle = subtitle;
      editingEntry.location = location;
      if (startVal) { editingEntry.start_y = parseInt(startVal.split('-')[0]); editingEntry.start_m = parseInt(startVal.split('-')[1]); }
      if (endVal) { editingEntry.end_y = parseInt(endVal.split('-')[0]); editingEntry.end_m = parseInt(endVal.split('-')[1]); }
      else { editingEntry.end_y = null; editingEntry.end_m = null; }
      editingEntry.description = desc;
      await saveEntry(editingEntry);
    } else {
      const entry = {
        id: genId(),
        category: modalCategory,
        title: title,
        subtitle: subtitle,
        location: location,
        start_y: startVal ? parseInt(startVal.split('-')[0]) : new Date().getFullYear(),
        start_m: startVal ? parseInt(startVal.split('-')[1]) : 1,
        end_y: endVal ? parseInt(endVal.split('-')[0]) : null,
        end_m: endVal ? parseInt(endVal.split('-')[1]) : null,
        description: desc,
        supabase_id: null,
        source: null,
        linked_id: null,
      };
      entries.push(entry);
      await saveEntry(entry);
    }
  }

  closeModal();
  render();
});

document.getElementById('m-delete').addEventListener('click', async () => {
  if (!editingEntry) return;
  if (!confirm('Delete this entry?')) return;

  if (editingPlace) {
    places = places.filter(p => p.id !== editingEntry.id);
    await deletePlaceFromDB(editingEntry);
  } else {
    entries = entries.filter(e => e.id !== editingEntry.id);
    await deleteEntryFromDB(editingEntry);
  }
  closeModal();
  render();
});

// ============ COLUMN ADD BUTTONS ============
document.querySelectorAll('.column .add-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    e.stopPropagation();
    const cat = btn.closest('.column').dataset.cat;
    openAddModal(cat);
  });
});

// ============ ADD PLACE BUTTON ============
document.getElementById('btn-add-place').addEventListener('click', () => {
  openPlaceModal(null);
});

// ============ SCROLL / ZOOM ============
document.getElementById('columns-container').addEventListener('wheel', e => {
  if (e.ctrlKey || e.metaKey) {
    e.preventDefault();
    const oldPPY = PIXELS_PER_YEAR;
    PIXELS_PER_YEAR = Math.max(20, Math.min(300, PIXELS_PER_YEAR - e.deltaY * 0.5));
    const rect = document.getElementById('columns-container').getBoundingClientRect();
    const mouseY = e.clientY - rect.top;
    const yearAtMouse = (mouseY - scrollOffset) / oldPPY + birthYear;
    scrollOffset = mouseY - (yearAtMouse - birthYear) * PIXELS_PER_YEAR;
    render();
  } else {
    scrollOffset -= e.deltaY;
    render();
  }
}, { passive: false });

document.getElementById('time-axis').addEventListener('wheel', e => {
  scrollOffset -= e.deltaY;
  render();
}, { passive: false });

// ============ HELPERS ============
let idCounter = 0;
function genId() { return 'e' + (++idCounter) + '_' + Date.now(); }

function esc(str) {
  const div = document.createElement('div');
  div.textContent = str || '';
  return div.innerHTML;
}

function hexToRgba(hex, alpha) {
  const r = parseInt(hex.slice(1,3), 16);
  const g = parseInt(hex.slice(3,5), 16);
  const b = parseInt(hex.slice(5,7), 16);
  return `rgba(${r},${g},${b},${alpha})`;
}

function rgbaToHex(rgba) {
  const match = rgba.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
  if (!match) return '#334455';
  const r = parseInt(match[1]).toString(16).padStart(2, '0');
  const g = parseInt(match[2]).toString(16).padStart(2, '0');
  const b = parseInt(match[3]).toString(16).padStart(2, '0');
  return `#${r}${g}${b}`;
}

// ============ KEYBOARD ============
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});

// ============ INIT ============
function initScroll() {
  scrollOffset = 40;
}

checkSession();
initScroll();
</script>
</body>
</html>