<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chronicle</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;1,400&family=DM+Mono:wght@300;400;500&display=swap');

*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg:#f0ead8;
  --paper:#f6f1e6;
  --ink:#1a1812;
  --ink-mid:#5a5040;
  --ink-dim:#9a8e78;
  --ink-faint:#d8d0c0;
  --axis-w:72px;
  --col-w:148px;
}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--ink);font-family:'DM Mono',monospace;display:flex;flex-direction:column;user-select:none;}

/* TOOLBAR */
.toolbar{flex-shrink:0;display:flex;align-items:center;border-bottom:2px solid var(--ink);background:var(--paper);z-index:60;height:40px;}
.tb-logo{padding:0 14px;border-right:1px solid var(--ink-faint);font-family:'Libre Baskerville',serif;font-style:italic;font-size:12px;color:var(--ink-mid);height:100%;display:flex;align-items:center;}
.tb-tools{display:flex;height:100%;border-right:1px solid var(--ink-faint);}
.tb-btn{width:38px;height:100%;display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;background:none;color:var(--ink-dim);font-size:15px;transition:all .15s;}
.tb-btn:hover{background:var(--bg);color:var(--ink);}
.tb-btn.active{background:var(--ink);color:var(--paper);}
.tb-zoom{display:flex;align-items:center;gap:9px;padding:0 14px;border-right:1px solid var(--ink-faint);height:100%;}
.tb-zoom label{font-size:7.5px;letter-spacing:.15em;color:var(--ink-dim);}
.zoom-track{position:relative;width:110px;height:3px;background:var(--ink-faint);border-radius:2px;cursor:pointer;}
.zoom-fill{position:absolute;left:0;top:0;height:100%;background:var(--ink-dim);border-radius:2px;pointer-events:none;}
.zoom-thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:12px;height:12px;border-radius:50%;background:var(--ink);cursor:grab;box-shadow:0 1px 4px rgba(0,0,0,.25);}
.zoom-val{font-size:9px;color:var(--ink-dim);min-width:34px;}
.tb-hint{padding:0 14px;font-size:7.5px;color:var(--ink-faint);letter-spacing:.06em;line-height:1.5;}

/* COL HEADERS */
.col-header-wrap{flex-shrink:0;display:flex;border-bottom:1.5px solid var(--ink);background:var(--paper);z-index:50;}
.axis-head{width:var(--axis-w);flex-shrink:0;border-right:2px solid var(--ink);display:flex;align-items:center;justify-content:center;}
.axis-head span{font-size:7px;letter-spacing:.15em;color:var(--ink-faint);text-transform:uppercase;}
.col-headers{display:flex;}
.col-hd{flex-shrink:0;border-right:1px solid var(--ink-faint);padding:7px 10px;display:flex;align-items:center;gap:6px;cursor:pointer;}
.col-hd:hover{background:var(--bg);}
.col-hd-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.col-hd-name{font-size:8px;letter-spacing:.16em;text-transform:uppercase;color:var(--ink-dim);}

/* SCROLL */
.scroll-wrap{flex:1;overflow-y:scroll;overflow-x:auto;position:relative;}
.scroll-wrap::-webkit-scrollbar{width:5px;}
.scroll-wrap::-webkit-scrollbar-thumb{background:var(--ink-faint);border-radius:3px;}

/* TIMELINE */
.tl{display:flex;position:relative;}
.tl-axis{width:var(--axis-w);flex-shrink:0;border-right:2px solid var(--ink);position:sticky;left:0;z-index:30;background:var(--paper);cursor:crosshair;}
.tl-grid{flex:1;position:relative;}

/* axis ticks */
.tick{position:absolute;right:0;display:flex;align-items:center;transform:translateY(-50%);padding-right:7px;gap:3px;pointer-events:none;}
.tick-yr{font-size:11px;color:var(--ink);letter-spacing:-.02em;}
.tick-ag{font-size:7px;color:var(--ink-faint);}
.tick-mark{position:absolute;right:-2px;width:5px;height:1.5px;background:var(--ink);}
.tick-5{position:absolute;right:-2px;width:8px;height:1px;background:var(--ink-dim);}

/* grid rules */
.yr-rule{position:absolute;left:0;right:0;pointer-events:none;z-index:2;}
.mo-rule{position:absolute;left:0;right:0;height:1px;background:rgba(0,0,0,.04);pointer-events:none;z-index:2;}
.col-rule{position:absolute;top:0;bottom:0;width:1px;background:rgba(0,0,0,.07);pointer-events:none;z-index:2;}

/* place bands */
.place-band{position:absolute;left:0;right:0;pointer-events:none;z-index:1;}
.place-lbl{position:absolute;left:6px;font-size:7px;letter-spacing:.12em;text-transform:uppercase;font-style:italic;pointer-events:none;z-index:3;opacity:.4;}
/* fuzzy top/bottom on place band */
.place-band-fuzzy-top{position:absolute;left:0;right:0;top:0;height:20px;pointer-events:none;}
.place-band-fuzzy-bot{position:absolute;left:0;right:0;bottom:0;height:20px;pointer-events:none;}

/* today */
.today-line{position:absolute;left:0;right:0;height:2px;background:#c84030;z-index:18;pointer-events:none;}
.today-line::after{content:'TODAY';position:absolute;right:4px;top:-9px;font-size:7px;letter-spacing:.14em;color:#c84030;}

/* ENTRIES */
.entry{position:absolute;border-radius:3px;overflow:visible;z-index:10;cursor:default;}
.entry-body{position:absolute;inset:0;border-radius:3px;padding:4px 7px;overflow:hidden;}
.entry-title{font-size:8px;font-weight:500;letter-spacing:.03em;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.entry-date{font-size:6.5px;opacity:.55;letter-spacing:.05em;margin-top:2px;}
/* fuzzy gradient overlays */
.entry-fuzzy-top{position:absolute;left:0;right:0;top:0;height:12px;border-radius:3px 3px 0 0;pointer-events:none;z-index:5;}
.entry-fuzzy-bot{position:absolute;left:0;right:0;bottom:0;height:12px;border-radius:0 0 3px 3px;pointer-events:none;z-index:5;}

/* resize handles */
.handle{position:absolute;left:0;right:0;height:8px;z-index:15;cursor:ns-resize;opacity:0;transition:opacity .15s;}
.handle:hover,.entry.selected .handle{opacity:1;}
.handle.top{top:-4px;}
.handle.bot{bottom:-4px;}
.handle-bar{position:absolute;left:50%;transform:translate(-50%,-50%);width:24px;height:3px;border-radius:2px;background:rgba(0,0,0,.28);top:50%;}

/* selection */
.entry.selected .entry-body{outline:2px solid var(--ink);outline-offset:1px;}

/* PERSON OBJECTS */
.person-obj{position:absolute;z-index:12;cursor:default;display:flex;align-items:center;}
.person-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;margin-left:6px;}
.person-label{font-size:8px;margin-left:7px;white-space:nowrap;letter-spacing:.02em;}
.person-tail{position:absolute;left:10px;pointer-events:none;width:2px;opacity:.18;}
.person-obj.selected .person-dot{outline:2px solid var(--ink);outline-offset:2px;}

/* TOOLTIP */
.tt{position:fixed;background:var(--ink);color:var(--paper);padding:5px 10px;border-radius:3px;font-size:9px;letter-spacing:.04em;pointer-events:none;z-index:400;opacity:0;transition:opacity .1s;max-width:280px;line-height:1.6;}
.tt.on{opacity:1;}

/* DELETE HINT */
.del-hint{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:var(--ink);color:var(--paper);padding:5px 14px;border-radius:20px;font-size:8px;letter-spacing:.1em;opacity:0;pointer-events:none;transition:opacity .2s;z-index:300;}
.del-hint.on{opacity:1;}

/* MODAL */
.mo{position:fixed;inset:0;background:rgba(18,16,10,.5);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .18s;backdrop-filter:blur(2px);}
.mo.open{opacity:1;pointer-events:all;}
.mo-box{background:var(--paper);border:1.5px solid var(--ink);border-radius:6px;padding:22px;width:360px;box-shadow:0 10px 36px rgba(0,0,0,.2);}
.mo-title{font-family:'Libre Baskerville',serif;font-style:italic;font-size:14px;margin-bottom:16px;}
.frow{margin-bottom:11px;}
.frow label{display:block;font-size:7.5px;letter-spacing:.17em;text-transform:uppercase;color:var(--ink-dim);margin-bottom:4px;}
.frow input,.frow select,.frow textarea{width:100%;background:var(--bg);border:1px solid var(--ink-faint);border-radius:3px;padding:6px 8px;font-family:'DM Mono',monospace;font-size:10.5px;color:var(--ink);outline:none;transition:border-color .12s;}
.frow input:focus,.frow select:focus,.frow textarea:focus{border-color:var(--ink-mid);}
.frow textarea{resize:vertical;min-height:46px;}
.fcols{display:grid;grid-template-columns:1fr 1fr;gap:9px;}
.swatches{display:flex;gap:5px;flex-wrap:wrap;}
.sw{width:20px;height:20px;border-radius:3px;cursor:pointer;border:2px solid transparent;transition:border-color .1s,transform .1s;}
.sw:hover{transform:scale(1.12);}
.sw.on{border-color:var(--ink);}
.fuzz-row{display:flex;gap:16px;align-items:center;}
.fuzz-check{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:9px;color:var(--ink-mid);letter-spacing:.04em;}
.fuzz-check input{width:13px;height:13px;cursor:pointer;accent-color:var(--ink);}
.mo-acts{display:flex;gap:7px;margin-top:16px;justify-content:flex-end;}
.btn{padding:6px 14px;border-radius:3px;font-family:'DM Mono',monospace;font-size:8.5px;letter-spacing:.12em;cursor:pointer;border:1px solid var(--ink-faint);background:none;color:var(--ink-mid);text-transform:uppercase;transition:all .13s;}
.btn:hover{border-color:var(--ink-mid);color:var(--ink);}
.btn.pri{background:var(--ink);color:var(--paper);border-color:var(--ink);}
.btn.pri:hover{background:#2a2418;}
.btn.danger{color:#c84030;border-color:rgba(200,64,48,.3);}
.btn.danger:hover{background:#c84030;color:var(--paper);border-color:#c84030;}
</style>
</head>
<body>

<div class="toolbar">
  <div class="tb-logo">chronicle</div>
  <div class="tb-tools">
    <button class="tb-btn active" id="toolSelect" title="Select" onclick="setTool('select')">&#9654;</button>
  </div>
  <div class="tb-zoom">
    <label>SCALE</label>
    <div class="zoom-track" id="zoomTrack">
      <div class="zoom-fill" id="zoomFill"></div>
      <div class="zoom-thumb" id="zoomThumb"></div>
    </div>
    <span class="zoom-val" id="zoomVal">1×</span>
  </div>
  <div class="tb-hint">
    click year axis → add geography &nbsp;·&nbsp; dbl-click column → new entry &nbsp;·&nbsp; drag body → move &nbsp;·&nbsp; drag edge → resize &nbsp;·&nbsp; del → delete
  </div>
</div>

<div class="col-header-wrap">
  <div class="axis-head"><span>geography</span></div>
  <div class="col-headers" id="colHeaders"></div>
</div>

<div class="scroll-wrap" id="scrollWrap">
  <div class="tl" id="tl">
    <div class="tl-axis" id="axis"></div>
    <div class="tl-grid" id="grid"></div>
  </div>
</div>

<div class="tt" id="tt"></div>
<div class="del-hint" id="delHint">DEL to delete selected</div>

<!-- MODAL -->
<div class="mo" id="mo">
  <div class="mo-box">
    <div class="mo-title" id="moTitle">New entry</div>
    <div class="frow" id="moTypeRow">
      <label>Category</label>
      <select id="fCat">
        <option value="work">Work / Employer</option>
        <option value="project">Project</option>
        <option value="personal">Personal / Family</option>
        <option value="residence">Residence</option>
        <option value="people">Person</option>
        <option value="tech">Tech context</option>
      </select>
    </div>
    <div class="frow"><label>Title / Name</label><input id="fTitle" placeholder="e.g. Lucasfilm, 136 Santa Cruz St…"></div>
    <div class="fcols">
      <div class="frow"><label>Start (YYYY-MM)</label><input id="fStart" placeholder="1985-06"></div>
      <div class="frow"><label>End (YYYY-MM or blank)</label><input id="fEnd" placeholder="1987-03"></div>
    </div>
    <div class="frow">
      <label>Fuzzy edges</label>
      <div class="fuzz-row">
        <label class="fuzz-check"><input type="checkbox" id="fFuzzyStart"> Uncertain start</label>
        <label class="fuzz-check"><input type="checkbox" id="fFuzzyEnd"> Uncertain end</label>
      </div>
    </div>
    <div class="frow"><label>Note</label><textarea id="fNote" placeholder="Anything worth remembering…"></textarea></div>
    <div class="frow" id="colorPickRow"><label>Color</label><div class="swatches" id="swatches"></div></div>
    <div class="mo-acts">
      <button class="btn danger" id="deleteBtn" style="display:none" onclick="deleteEntry()">Delete</button>
      <button class="btn" id="cancelBtn">Cancel</button>
      <button class="btn pri" id="saveBtn">Save</button>
    </div>
  </div>
</div>

<!-- GEO MODAL -->
<div class="mo" id="geoMo">
  <div class="mo-box">
    <div class="mo-title">Geography — place context</div>
    <div class="frow"><label>Place name</label><input id="gTitle" placeholder="e.g. San Francisco Bay Area"></div>
    <div class="fcols">
      <div class="frow"><label>Start (YYYY-MM)</label><input id="gStart"></div>
      <div class="frow"><label>End (YYYY-MM or blank)</label><input id="gEnd"></div>
    </div>
    <div class="frow">
      <label>Fuzzy edges</label>
      <div class="fuzz-row">
        <label class="fuzz-check"><input type="checkbox" id="gFuzzyStart"> Uncertain start</label>
        <label class="fuzz-check"><input type="checkbox" id="gFuzzyEnd"> Uncertain end</label>
      </div>
    </div>
    <div class="frow"><label>Background color</label><div class="swatches" id="geoSwatches"></div></div>
    <div class="mo-acts">
      <button class="btn danger" id="geoDeleteBtn" style="display:none" onclick="deleteGeo()">Delete</button>
      <button class="btn" id="geoCancelBtn">Cancel</button>
      <button class="btn pri" id="geoSaveBtn">Save</button>
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════════════
const START_YEAR = 1975;
const END_YEAR   = 2032;
const BIRTH_YEAR = 1963;
const BASE_PXM   = 28;
let   SCALE      = 1.0;
const ZOOM_MIN   = 0.08;  // very zoomed out — see 50+ years
const ZOOM_MAX   = 3.0;
const COL_W      = 148;
const AXIS_W     = 72;

// Columns — People on the right
const COLS = [
  {id:'work',      label:'Work',       color:'#4070a8'},
  {id:'project',   label:'Projects',   color:'#508038'},
  {id:'personal',  label:'Personal',   color:'#a85060'},
  {id:'residence', label:'Residences', color:'#806840'},
  {id:'tech',      label:'Tech',       color:'#986020'},
  {id:'people',    label:'People',     color:'#7050a8'},
];

const PAL = {
  work:      ['#2d5080','#4070a8','#5890c8','#386098','#6080b0'],
  project:   ['#306018','#508038','#70a050','#407028','#609040'],
  personal:  ['#802838','#a85060','#c87080','#903848','#b06070'],
  residence: ['#604820','#806840','#a08858','#705030','#907848'],
  tech:      ['#604018','#986020','#b88040','#785030','#a07030'],
  people:    ['#482870','#7050a8','#9070c8','#583888','#806ab8'],
  geo: ['#c0b484','#b8c8a8','#c0a890','#90a8c0','#c0b890','#a890c0','#c09888',
        '#b8d0b8','#d0c0a0','#a8c0d0','#c8b0c0','#b0c8c0','#d0b8a8','#b0b8d0','#c8d0b0'],
};

// ═══════════════════════════════════════════════
// DATA
// ═══════════════════════════════════════════════
let PLACES = [
  {id:'pl1',title:'Providence, RI',      start:'1981-09',end:'1985-06',color:'#c0b484',fuzzyStart:false,fuzzyEnd:false,note:'Brown years'},
  {id:'pl2',title:'San Rafael / Palo Alto',start:'1985-06',end:'1988-01',color:'#a8c0a0',fuzzyStart:false,fuzzyEnd:false,note:'Lucasfilm era'},
  {id:'pl3',title:'Los Angeles',          start:'1988-01',end:'1993-06',color:'#c0a890',fuzzyStart:false,fuzzyEnd:false,note:'Post Group era'},
  {id:'pl4',title:'Santa Cruz / Bay Area', start:'1993-06',end:'2009-01',color:'#90a8c0',fuzzyStart:false,fuzzyEnd:false,note:'Petroglyph years'},
  {id:'pl5',title:'Boulder, CO',           start:'2009-01',end:'2010-09',color:'#c0b890',fuzzyStart:false,fuzzyEnd:false,note:'PublicEarth'},
  {id:'pl6',title:'San Francisco',         start:'2010-09',end:'2021-01',color:'#a890c0',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'pl7',title:'Santa Fe, NM',          start:'2021-01',end:'2026-02',color:'#c09888',fuzzyStart:false,fuzzyEnd:true,note:'Current'},
];

let DATA = [
  // WORK
  {id:'w1',cat:'work',title:'Lucasfilm',        start:'1985-06',end:'1987-06',color:'#4070a8',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'w2',cat:'work',title:'Sonic Solutions',  start:'1987-06',end:'1987-12',color:'#386098',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'w3',cat:'work',title:'The Post Group',   start:'1988-01',end:'1993-06',color:'#2d5080',fuzzyStart:false,fuzzyEnd:false,note:'Freelance editing'},
  {id:'w4',cat:'work',title:'Petroglyph',       start:'1993-06',end:'2008-01',color:'#4070a8',fuzzyStart:false,fuzzyEnd:false,note:'Long run'},
  {id:'w5',cat:'work',title:'Netflix',          start:'2006-06',end:'2008-06',color:'#c03030',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'w6',cat:'work',title:'PublicEarth',      start:'2010-01',end:'2011-06',color:'#386098',fuzzyStart:false,fuzzyEnd:false,note:''},

  // PROJECTS
  {id:'pr1',cat:'project',title:'Defending the Galaxy',start:'1982-01',end:'1982-12',color:'#508038',fuzzyStart:true,fuzzyEnd:true,note:''},
  {id:'pr2',cat:'project',title:'Twilight Zone',       start:'1986-01',end:'1986-12',color:'#407028',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'pr3',cat:'project',title:'Lonesome Dove',       start:'1988-01',end:'1988-12',color:'#508038',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'pr4',cat:'project',title:'Nonlinear 1–4',       start:'1991-01',end:'2000-12',color:'#306018',fuzzyStart:false,fuzzyEnd:false,note:'iLife books'},
  {id:'pr5',cat:'project',title:'Little Digital Video',start:'2001-01',end:'2001-12',color:'#60904a',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'pr6',cat:'project',title:'iLife 04–06 / FCP',   start:'2002-01',end:'2006-12',color:'#508038',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'pr7',cat:'project',title:'Droidmaker + Tour',   start:'2004-01',end:'2006-12',color:'#407028',fuzzyStart:false,fuzzyEnd:false,note:''},

  // PERSONAL
  {id:'pe1',cat:'personal',title:'Brown University', start:'1981-09',end:'1985-06',color:'#a85060',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'pe2',cat:'personal',title:'Married',          start:'1994-01',end:'1994-03',color:'#903848',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'pe3',cat:'personal',title:'Jonah Born',       start:'2000-03',end:'2000-06',color:'#c07888',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'pe4',cat:'personal',title:'Alina Born',       start:'2002-05',end:'2002-08',color:'#c07888',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'pe5',cat:'personal',title:'Remodel House',    start:'2004-01',end:'2005-12',color:'#a85060',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'pe6',cat:'personal',title:'Stroke · Fiji',    start:'2008-06',end:'2008-09',color:'#802838',fuzzyStart:false,fuzzyEnd:false,note:'Recovery'},
  {id:'pe7',cat:'personal',title:'Kids at Gateway',  start:'2006-01',end:'2016-06',color:'#a85060',fuzzyStart:false,fuzzyEnd:false,note:''},

  // RESIDENCES
  {id:'r1',cat:'residence',title:'1533 4th St, San Rafael',      start:'1985-06',end:'1987-01',color:'#806840',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'r2',cat:'residence',title:'442 Monroe Dr, Palo Alto',     start:'1987-01',end:'1988-01',color:'#806840',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'r3',cat:'residence',title:'2620 Creston Dr, Los Angeles', start:'1987-06',end:'1988-06',color:'#806840',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'r4',cat:'residence',title:'2749 Hollyridge Dr, LA',       start:'1988-06',end:'1996-01',color:'#806840',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'r5',cat:'residence',title:'226 S Branciforte, Santa Cruz',start:'1993-06',end:'1996-01',color:'#706030',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'r6',cat:'residence',title:'3470 Houts Drive, SC',         start:'1996-01',end:'2011-01',color:'#806840',fuzzyStart:false,fuzzyEnd:false,note:'136 Santa Cruz St era'},
  {id:'r7',cat:'residence',title:'1634 17th St, Boulder',        start:'2009-01',end:'2010-09',color:'#706030',fuzzyStart:false,fuzzyEnd:false,note:'PublicEarth'},
  {id:'r8',cat:'residence',title:'296 Francisco St, SF',         start:'2011-01',end:'2021-01',color:'#806840',fuzzyStart:false,fuzzyEnd:false,note:''},

  // TECH
  {id:'t1',cat:'tech',title:'Mac · CD-ROM · Email', start:'1984-01',end:'1993-12',color:'#986020',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'t2',cat:'tech',title:'WWW · Avid',           start:'1993-01',end:'2003-12',color:'#785030',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'t3',cat:'tech',title:'MiniDV · iLife',       start:'2000-01',end:'2008-12',color:'#986020',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'t4',cat:'tech',title:'iPhone · DSLR',        start:'2008-01',end:'2015-12',color:'#804020',fuzzyStart:false,fuzzyEnd:false,note:''},
  {id:'t5',cat:'tech',title:'Mobile · AI',          start:'2015-01',end:'2026-02',color:'#a07030',fuzzyStart:false,fuzzyEnd:false,note:''},

  // PEOPLE
  {id:'pp1',cat:'people',title:'J. Weisbein',  start:'1982-09',end:null,color:'#7050a8',fuzzyStart:false,fuzzyEnd:false,note:'Brown — still close'},
  {id:'pp2',cat:'people',title:'D. Rubin',     start:'1983-01',end:null,color:'#7050a8',fuzzyStart:true, fuzzyEnd:false,note:'Brown'},
  {id:'pp3',cat:'people',title:'S. Arnold',    start:'1985-09',end:null,color:'#9070c8',fuzzyStart:false,fuzzyEnd:false,note:'Lucasfilm / sound'},
  {id:'pp4',cat:'people',title:'K. Bishop',    start:'1993-01',end:null,color:'#806ab8',fuzzyStart:true, fuzzyEnd:false,note:'Media / Netflix'},
  {id:'pp5',cat:'people',title:'A. Carney',    start:'2001-06',end:null,color:'#583888',fuzzyStart:false,fuzzyEnd:false,note:'Netflix VP'},
  {id:'pp6',cat:'people',title:'P. Russo',     start:'2003-01',end:null,color:'#9070c8',fuzzyStart:false,fuzzyEnd:false,note:'Netflix → Santa Fe'},
  {id:'pp7',cat:'people',title:'E. Montoya',   start:'2012-03',end:null,color:'#7050a8',fuzzyStart:true, fuzzyEnd:false,note:'Santa Fe gallery'},
  {id:'pp8',cat:'people',title:'A. Rosen',     start:'2007-06',end:null,color:'#806ab8',fuzzyStart:false,fuzzyEnd:false,note:'Photography'},
  {id:'pp9',cat:'people',title:'C. Delgado',   start:'2010-09',end:null,color:'#7050a8',fuzzyStart:false,fuzzyEnd:false,note:'Santa Fe'},
];

// ═══════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════
let selectedId   = null;
let dragState    = null;
let editingId    = null;
let editingGeoId = null;
let pickedColor  = '#4070a8';
let geoColor     = '#c0b484';
let zDrag        = false;

// ═══════════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════════
function pxm()       { return BASE_PXM * SCALE; }
function totalH()    { return (END_YEAR - START_YEAR) * 12 * pxm(); }
function parseYM(s)  { if(!s)return null; const p=s.split('-'); return {y:+p[0],m:+(p[1]||1)}; }
function toMo(ym)    { return (ym.y-START_YEAR)*12+(ym.m-1); }
function toPx(ym)    { return toMo(ym)*pxm(); }
function pxToYM(px)  { const mo=Math.round(px/pxm()); return {y:START_YEAR+Math.floor(mo/12),m:(mo%12)+1}; }
function fmtYM(ym)   { return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][ym.m-1]+' '+ym.y; }
function ymStr(ym)   { return ym.y+'-'+String(ym.m).padStart(2,'0'); }
function hex2rgba(h,a){ const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16); return `rgba(${r},${g},${b},${a})`; }
function colLeft(c)  { return COLS.findIndex(x=>x.id===c)*COL_W; }
function getEntry(id){ return DATA.find(e=>e.id===id)||PLACES.find(e=>e.id===id); }

// ═══════════════════════════════════════════════
// BUILD CHROME
// ═══════════════════════════════════════════════
function buildChrome() {
  // col headers
  const ch=document.getElementById('colHeaders');
  ch.innerHTML='';
  COLS.forEach(c=>{
    const d=document.createElement('div');
    d.className='col-hd'; d.style.width=COL_W+'px'; d.dataset.col=c.id;
    d.innerHTML=`<span class="col-hd-dot" style="background:${c.color}"></span><span class="col-hd-name">${c.label}</span>`;
    d.addEventListener('dblclick',()=>openNewModal(c.id));
    ch.appendChild(d);
  });

  const ax=document.getElementById('axis');
  ax.innerHTML=''; ax.style.height=totalH()+'px';

  const showMonths = pxm() >= 10;
  const showEvery  = pxm() < 4 ? 10 : pxm() < 8 ? 5 : 1;

  for(let y=START_YEAR;y<=END_YEAR;y++){
    if((y-START_YEAR) % showEvery !== 0) continue;
    const top=toPx({y,m:1}); const age=y-BIRTH_YEAR;
    const t=document.createElement('div'); t.className='tick'; t.style.top=top+'px';
    const isDecade=(y%10===0), isFive=(y%5===0);
    t.innerHTML=`<span class="tick-yr" style="font-size:${isDecade?13:isFive?11:9.5}px;opacity:${isDecade?1:isFive?.8:.6}">${y}</span>`
      +`<span class="tick-ag">${age>0?age:''}</span>`
      +`<div class="${isFive?'tick-5':'tick-mark'}"></div>`;
    ax.appendChild(t);
  }

  const g=document.getElementById('grid');
  g.querySelectorAll('.yr-rule,.mo-rule,.col-rule,.today-line').forEach(e=>e.remove());
  g.style.height=totalH()+'px';
  g.style.width=(COLS.length*COL_W)+'px';
  document.getElementById('tl').style.minWidth=(AXIS_W+COLS.length*COL_W)+'px';

  for(let y=START_YEAR;y<=END_YEAR;y++){
    const r=document.createElement('div'); r.className='yr-rule';
    const isDecade=(y%10===0);
    r.style.cssText=`top:${toPx({y,m:1})}px;height:${isDecade?2:1}px;background:rgba(0,0,0,${isDecade?.18:.1});`;
    g.appendChild(r);
    if(showMonths){
      for(let m=2;m<=12;m++){
        const mr=document.createElement('div'); mr.className='mo-rule';
        mr.style.top=toPx({y,m})+'px'; g.appendChild(mr);
      }
    }
  }
  COLS.forEach((c,i)=>{ if(!i)return; const v=document.createElement('div'); v.className='col-rule'; v.style.left=(i*COL_W)+'px'; g.appendChild(v); });

  const now=new Date();
  if(now.getFullYear()>=START_YEAR){
    const tl=document.createElement('div'); tl.className='today-line';
    tl.style.top=toPx({y:now.getFullYear(),m:now.getMonth()+1})+'px'; g.appendChild(tl);
  }

  // axis click → geography
  ax.onclick = ev => {
    const rect=ax.getBoundingClientRect();
    const relY=ev.clientY-rect.top+document.getElementById('scrollWrap').scrollTop;
    const ym=pxToYM(relY);
    // check if clicking existing place
    const hit=PLACES.find(p=>{
      const s=parseYM(p.start), en=p.end?parseYM(p.end):{y:END_YEAR,m:1};
      return toMo(ym)>=toMo(s)&&toMo(ym)<toMo(en);
    });
    openGeoModal(ym, hit||null);
  };

  g.addEventListener('dblclick', gridDblClick);
}

function gridDblClick(ev){
  const rect=document.getElementById('grid').getBoundingClientRect();
  const relX=ev.clientX-rect.left;
  const relY=ev.clientY-rect.top+document.getElementById('scrollWrap').scrollTop;
  const colIdx=Math.floor(relX/COL_W);
  if(colIdx<0||colIdx>=COLS.length)return;
  openNewModal(COLS[colIdx].id, pxToYM(relY));
}

// ═══════════════════════════════════════════════
// RENDER
// ═══════════════════════════════════════════════
function renderAll(){
  document.querySelectorAll('.entry,.place-band,.place-lbl,.person-obj').forEach(e=>e.remove());
  const g=document.getElementById('grid');
  PLACES.forEach(p=>renderPlace(p,g));
  DATA.filter(e=>e.cat==='people').forEach(e=>renderPerson(e,g));
  DATA.filter(e=>e.cat!=='people').forEach(e=>renderEntry(e,g));
}

function makeFuzzyOverlay(color, direction){
  // direction: 'top' or 'bot'
  const el=document.createElement('div');
  el.className=`entry-fuzzy-${direction}`;
  const from=direction==='top'?hex2rgba(color,.22):'transparent';
  const to  =direction==='top'?'transparent':hex2rgba(color,.22);
  el.style.background=`linear-gradient(${direction==='top'?'to bottom':'to top'},${from},${to})`;
  return el;
}

function renderPlace(p,g){
  const s=parseYM(p.start);
  const en=p.end?parseYM(p.end):{y:END_YEAR,m:1};
  const top=toPx(s), h=toPx(en)-top;

  const b=document.createElement('div'); b.className='place-band'; b.dataset.id=p.id;
  b.style.cssText=`top:${top}px;height:${h}px;background:${hex2rgba(p.color,.2)};`;
  if(!p.fuzzyStart) b.style.borderTop=`1.5px solid ${hex2rgba(p.color,.35)}`;
  if(p.fuzzyStart){
    const fz=document.createElement('div');
    fz.className='place-band-fuzzy-top';
    fz.style.background=`linear-gradient(to bottom,transparent,${hex2rgba(p.color,.2)})`;
    b.appendChild(fz);
  }
  if(p.fuzzyEnd){
    const fz=document.createElement('div');
    fz.className='place-band-fuzzy-bot';
    fz.style.background=`linear-gradient(to top,transparent,${hex2rgba(p.color,.2)})`;
    b.appendChild(fz);
  }
  b.addEventListener('dblclick',()=>openGeoModal(null,p));
  g.appendChild(b);

  // label (only if tall enough)
  if(h > pxm()*2){
    const l=document.createElement('div'); l.className='place-lbl';
    l.style.cssText=`top:${top+6}px;color:${p.color};font-size:${Math.max(6,Math.min(8,pxm()*.3))}px;`;
    l.textContent=p.title; g.appendChild(l);
  }
}

function renderPerson(e,g){
  const s=parseYM(e.start);
  const top=toPx(s);
  const dotH=Math.max(14, pxm()*0.9);
  const left=colLeft('people');

  const obj=document.createElement('div');
  obj.className='person-obj'+(selectedId===e.id?' selected':'');
  obj.dataset.id=e.id;
  obj.style.cssText=`top:${top}px;left:${left}px;width:${COL_W}px;height:${dotH}px;`;

  if(e.fuzzyStart){
    // dashed circle
    const dot=document.createElement('div');
    dot.className='person-dot';
    dot.style.cssText=`background:transparent;border:2px dashed ${e.color};box-sizing:border-box;`;
    obj.appendChild(dot);
  } else {
    const dot=document.createElement('div');
    dot.className='person-dot'; dot.style.background=e.color;
    obj.appendChild(dot);
  }

  const nm=document.createElement('div');
  nm.className='person-label'; nm.style.color=e.color;
  nm.textContent=e.title; obj.appendChild(nm);

  // tail
  if(!e.end){
    const en={y:END_YEAR,m:1};
    const tailH=toPx(en)-top-dotH/2;
    const tail=document.createElement('div');
    tail.className='person-tail';
    tail.style.cssText=`top:${dotH/2}px;height:${tailH}px;background:${e.color};`;
    obj.appendChild(tail);
  }

  g.appendChild(obj);
  obj.addEventListener('mousedown',ev=>startDrag(ev,e,'move'));
  obj.addEventListener('click',ev=>{ ev.stopPropagation(); selectEntry(e.id); });
  obj.addEventListener('dblclick',ev=>{ ev.stopPropagation(); openEditModal(e.id); });
  addHover(obj,e);
}

function renderEntry(e,g){
  const s=parseYM(e.start);
  const en=e.end?parseYM(e.end):null;
  const top=toPx(s);
  const h=en?Math.max(Math.round(pxm()),toPx(en)-top):Math.round(pxm()*2);
  const left=colLeft(e.cat)+3, w=COL_W-7;

  const wrap=document.createElement('div');
  wrap.className='entry'+(selectedId===e.id?' selected':'');
  wrap.dataset.id=e.id;
  wrap.style.cssText=`top:${top}px;left:${left}px;width:${w}px;height:${h}px;`;

  const body=document.createElement('div'); body.className='entry-body';
  body.style.cssText=`background:${hex2rgba(e.color,.17)};border:1px solid ${hex2rgba(e.color,.48)};`;

  const showDate=h>Math.round(pxm()*1.2);
  body.innerHTML=`<div class="entry-title" style="color:${e.color};font-size:${Math.max(6,Math.min(8.5,pxm()*.35))}px">${e.title}</div>`
    +(showDate?`<div class="entry-date">${e.start}${e.end?' – '+e.end:''}</div>`:'');
  wrap.appendChild(body);

  if(e.fuzzyStart) body.appendChild(makeFuzzyOverlay(e.color,'top'));
  if(e.fuzzyEnd)   body.appendChild(makeFuzzyOverlay(e.color,'bot'));

  // handles
  ['top','bot'].forEach(dir=>{
    const h2=document.createElement('div'); h2.className=`handle ${dir}`;
    h2.innerHTML='<div class="handle-bar"></div>';
    h2.addEventListener('mousedown',ev=>startDrag(ev,e,dir));
    wrap.appendChild(h2);
  });

  g.appendChild(wrap);
  body.addEventListener('mousedown',ev=>startDrag(ev,e,'move'));
  body.addEventListener('click',ev=>{ ev.stopPropagation(); selectEntry(e.id); });
  body.addEventListener('dblclick',ev=>{ ev.stopPropagation(); openEditModal(e.id); });
  addHover(wrap,e);
}

// ═══════════════════════════════════════════════
// SELECTION
// ═══════════════════════════════════════════════
function selectEntry(id){
  selectedId=id;
  document.querySelectorAll('.entry,.person-obj').forEach(el=>el.classList.toggle('selected',el.dataset.id===id));
  if(id){ const h=document.getElementById('delHint'); h.classList.add('on'); setTimeout(()=>h.classList.remove('on'),2000); }
}

document.addEventListener('click',ev=>{
  if(!ev.target.closest('.entry,.person-obj,.mo-box,#geoMo .mo-box')){
    selectedId=null;
    document.querySelectorAll('.entry,.person-obj').forEach(el=>el.classList.remove('selected'));
  }
});

// ═══════════════════════════════════════════════
// DRAGGING
// ═══════════════════════════════════════════════
function startDrag(ev,e,type){
  if(ev.button!==0)return;
  selectEntry(e.id);
  const el=document.querySelector(`[data-id="${e.id}"]`);
  dragState={type,id:e.id,startY:ev.clientY,origTop:parseInt(el.style.top)||0,origH:parseInt(el.style.height)||0};
  ev.preventDefault(); ev.stopPropagation();
}

document.addEventListener('mousemove',ev=>{
  if(!dragState)return;
  const pm=pxm(), dy=ev.clientY-dragState.startY;
  const el=document.querySelector(`[data-id="${dragState.id}"]`);
  if(!el)return;
  if(dragState.type==='move'){
    el.style.top=Math.max(0,dragState.origTop+dy)+'px';
    showTT(ev,fmtYM(pxToYM(parseInt(el.style.top))));
  } else if(dragState.type==='top'){
    const newTop=Math.max(0,dragState.origTop+dy);
    el.style.top=newTop+'px'; el.style.height=Math.max(pm,dragState.origH-dy)+'px';
    showTT(ev,fmtYM(pxToYM(newTop)));
  } else {
    el.style.height=Math.max(pm,dragState.origH+dy)+'px';
    showTT(ev,fmtYM(pxToYM(dragState.origTop+parseInt(el.style.height))));
  }
});

document.addEventListener('mouseup',()=>{
  if(!dragState)return;
  const pm=pxm();
  const el=document.querySelector(`[data-id="${dragState.id}"]`);
  const e=getEntry(dragState.id);
  if(el&&e){
    const sn=v=>Math.round(v/pm)*pm;
    const snapTop=sn(parseInt(el.style.top)||0);
    const snapH=Math.max(pm,sn(parseInt(el.style.height)||0));
    el.style.top=snapTop+'px'; el.style.height=snapH+'px';
    const ns=pxToYM(snapTop), ne=pxToYM(snapTop+snapH);
    e.start=ymStr(ns);
    if(e.cat!=='people') e.end=ymStr(ne);
    const dt=el.querySelector('.entry-date');
    if(dt) dt.textContent=e.start+(e.end?' – '+e.end:'');
  }
  hideTT(); dragState=null;
});

// ═══════════════════════════════════════════════
// KEYBOARD
// ═══════════════════════════════════════════════
document.addEventListener('keydown',ev=>{
  if(ev.target.matches('input,textarea,select'))return;
  if((ev.key==='Delete'||ev.key==='Backspace')&&selectedId){
    DATA=DATA.filter(e=>e.id!==selectedId);
    selectedId=null; renderAll();
  }
  if(ev.key==='Escape'){
    selectedId=null;
    document.querySelectorAll('.entry,.person-obj').forEach(el=>el.classList.remove('selected'));
    document.getElementById('mo').classList.remove('open');
    document.getElementById('geoMo').classList.remove('open');
  }
});

// ═══════════════════════════════════════════════
// TOOLTIP
// ═══════════════════════════════════════════════
function addHover(el,e){
  el.addEventListener('mouseenter',ev=>{ if(!dragState){ const p=[e.title,e.start+(e.end?' – '+e.end:'')]; if(e.note)p.push(e.note); showTT(ev,p.join(' · ')); }});
  el.addEventListener('mousemove',ev=>{ if(!dragState)moveTT(ev); });
  el.addEventListener('mouseleave',()=>{ if(!dragState)hideTT(); });
}
function showTT(ev,t){ const el=document.getElementById('tt'); el.textContent=t; el.classList.add('on'); moveTT(ev); }
function moveTT(ev){ const el=document.getElementById('tt'); el.style.left=(ev.clientX+14)+'px'; el.style.top=(ev.clientY-8)+'px'; }
function hideTT(){ document.getElementById('tt').classList.remove('on'); }

// ═══════════════════════════════════════════════
// ENTRY MODAL
// ═══════════════════════════════════════════════
function buildSwatches(cat, currentColor){
  const sw=document.getElementById('swatches'); sw.innerHTML='';
  const pal=PAL[cat]||PAL.work;
  const startColor=currentColor||pal[0];
  pal.forEach(c=>{
    const s=document.createElement('div'); s.className='sw'+(c===startColor?' on':'');
    s.style.background=c; s.dataset.c=c;
    s.onclick=()=>{ document.querySelectorAll('#swatches .sw').forEach(x=>x.classList.remove('on')); s.classList.add('on'); pickedColor=c; };
    sw.appendChild(s);
  });
  pickedColor=startColor;
}

function openNewModal(cat, ym){
  editingId=null;
  document.getElementById('moTitle').textContent='New '+( COLS.find(c=>c.id===cat)?.label||'entry' );
  document.getElementById('fCat').value=cat; document.getElementById('fCat').disabled=true;
  document.getElementById('fTitle').value='';
  document.getElementById('fStart').value=ym?ymStr(ym):'';
  document.getElementById('fEnd').value='';
  document.getElementById('fFuzzyStart').checked=false;
  document.getElementById('fFuzzyEnd').checked=false;
  document.getElementById('fNote').value='';
  document.getElementById('deleteBtn').style.display='none';
  buildSwatches(cat);
  document.getElementById('mo').classList.add('open');
  setTimeout(()=>document.getElementById('fTitle').focus(),80);
}

function openEditModal(id){
  const e=DATA.find(x=>x.id===id); if(!e)return;
  editingId=id;
  document.getElementById('moTitle').textContent='Edit entry';
  document.getElementById('fCat').value=e.cat; document.getElementById('fCat').disabled=false;
  document.getElementById('fTitle').value=e.title;
  document.getElementById('fStart').value=e.start||'';
  document.getElementById('fEnd').value=e.end||'';
  document.getElementById('fFuzzyStart').checked=!!e.fuzzyStart;
  document.getElementById('fFuzzyEnd').checked=!!e.fuzzyEnd;
  document.getElementById('fNote').value=e.note||'';
  document.getElementById('deleteBtn').style.display='inline-block';
  buildSwatches(e.cat, e.color);
  document.getElementById('mo').classList.add('open');
  setTimeout(()=>document.getElementById('fTitle').focus(),80);
}

function deleteEntry(){
  if(!editingId)return;
  DATA=DATA.filter(e=>e.id!==editingId);
  selectedId=null; editingId=null;
  document.getElementById('mo').classList.remove('open');
  renderAll();
}

document.getElementById('fCat').addEventListener('change',ev=>buildSwatches(ev.target.value));
document.getElementById('cancelBtn').onclick=()=>document.getElementById('mo').classList.remove('open');
document.getElementById('mo').addEventListener('click',ev=>{ if(ev.target===document.getElementById('mo'))document.getElementById('mo').classList.remove('open'); });

document.getElementById('saveBtn').onclick=()=>{
  const cat=document.getElementById('fCat').value;
  const title=document.getElementById('fTitle').value.trim();
  const start=document.getElementById('fStart').value.trim();
  const end=document.getElementById('fEnd').value.trim()||null;
  const fuzzyStart=document.getElementById('fFuzzyStart').checked;
  const fuzzyEnd=document.getElementById('fFuzzyEnd').checked;
  const note=document.getElementById('fNote').value.trim();
  if(!title||!start)return;
  if(editingId){
    const e=DATA.find(x=>x.id===editingId);
    if(e) Object.assign(e,{cat,title,start,end,fuzzyStart,fuzzyEnd,note,color:pickedColor});
  } else {
    DATA.push({id:'e'+Date.now(),cat,title,start,end,fuzzyStart,fuzzyEnd,color:pickedColor,note});
  }
  document.getElementById('mo').classList.remove('open');
  buildChrome(); renderAll();
  const ym=parseYM(start);
  if(ym) document.getElementById('scrollWrap').scrollTop=toPx(ym)-80;
};

// ═══════════════════════════════════════════════
// GEO MODAL
// ═══════════════════════════════════════════════
function buildGeoSwatches(current){
  const sw=document.getElementById('geoSwatches'); sw.innerHTML='';
  PAL.geo.forEach(c=>{
    const s=document.createElement('div'); s.className='sw'+(c===current?' on':'');
    s.style.background=c; s.dataset.c=c;
    s.onclick=()=>{ document.querySelectorAll('#geoSwatches .sw').forEach(x=>x.classList.remove('on')); s.classList.add('on'); geoColor=c; };
    sw.appendChild(s);
  });
  geoColor=current||PAL.geo[0];
}

function openGeoModal(ym, existing){
  editingGeoId = existing ? existing.id : null;
  document.getElementById('geoDeleteBtn').style.display = existing ? 'inline-block' : 'none';
  document.getElementById('gTitle').value = existing ? existing.title : '';
  document.getElementById('gStart').value = existing ? existing.start : (ym?ymStr(ym):'');
  document.getElementById('gEnd').value   = existing ? (existing.end||'') : '';
  document.getElementById('gFuzzyStart').checked = existing ? !!existing.fuzzyStart : false;
  document.getElementById('gFuzzyEnd').checked   = existing ? !!existing.fuzzyEnd   : false;
  buildGeoSwatches(existing ? existing.color : PAL.geo[0]);
  document.getElementById('geoMo').classList.add('open');
  setTimeout(()=>document.getElementById('gTitle').focus(),80);
}

function deleteGeo(){
  if(!editingGeoId)return;
  PLACES=PLACES.filter(p=>p.id!==editingGeoId);
  editingGeoId=null;
  document.getElementById('geoMo').classList.remove('open');
  buildChrome(); renderAll();
}

document.getElementById('geoCancelBtn').onclick=()=>document.getElementById('geoMo').classList.remove('open');
document.getElementById('geoMo').addEventListener('click',ev=>{ if(ev.target===document.getElementById('geoMo'))document.getElementById('geoMo').classList.remove('open'); });

document.getElementById('geoSaveBtn').onclick=()=>{
  const title=document.getElementById('gTitle').value.trim();
  const start=document.getElementById('gStart').value.trim();
  const end=document.getElementById('gEnd').value.trim()||null;
  const fuzzyStart=document.getElementById('gFuzzyStart').checked;
  const fuzzyEnd=document.getElementById('gFuzzyEnd').checked;
  if(!title||!start)return;
  if(editingGeoId){
    const p=PLACES.find(x=>x.id===editingGeoId);
    if(p) Object.assign(p,{title,start,end,fuzzyStart,fuzzyEnd,color:geoColor});
  } else {
    PLACES.push({id:'pl'+Date.now(),title,start,end,fuzzyStart,fuzzyEnd,color:geoColor,note:''});
  }
  document.getElementById('geoMo').classList.remove('open');
  buildChrome(); renderAll();
};

// ═══════════════════════════════════════════════
// ZOOM
// ═══════════════════════════════════════════════
function applyZoom(scale){
  const sw=document.getElementById('scrollWrap');
  const centerPx=sw.scrollTop+sw.clientHeight/2;
  const centerYM=pxToYM(centerPx);
  SCALE=Math.max(ZOOM_MIN,Math.min(ZOOM_MAX,scale));
  const pct=(SCALE-ZOOM_MIN)/(ZOOM_MAX-ZOOM_MIN);
  document.getElementById('zoomVal').textContent=SCALE>=1?SCALE.toFixed(1).replace(/\.0$/,'')+'×':(SCALE*100).toFixed(0)+'%';
  document.getElementById('zoomFill').style.width=(pct*100)+'%';
  document.getElementById('zoomThumb').style.left=(pct*100)+'%';
  buildChrome(); renderAll();
  sw.scrollTop=toPx(centerYM)-sw.clientHeight/2;
}

function zoomFromTrack(ev){
  const rect=document.getElementById('zoomTrack').getBoundingClientRect();
  applyZoom(ZOOM_MIN+(Math.max(0,Math.min(1,(ev.clientX-rect.left)/rect.width)))*(ZOOM_MAX-ZOOM_MIN));
}
document.getElementById('zoomTrack').addEventListener('mousedown',ev=>{ zDrag=true; zoomFromTrack(ev); ev.preventDefault(); });
document.addEventListener('mousemove',ev=>{ if(zDrag)zoomFromTrack(ev); });
document.addEventListener('mouseup',()=>zDrag=false);

function setTool(t){ document.getElementById('toolSelect').classList.toggle('active',t==='select'); }

// ═══════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════
// Set zoom thumb initial position
(()=>{ const pct=(SCALE-ZOOM_MIN)/(ZOOM_MAX-ZOOM_MIN); document.getElementById('zoomFill').style.width=(pct*100)+'%'; document.getElementById('zoomThumb').style.left=(pct*100)+'%'; })();
buildChrome();
renderAll();
requestAnimationFrame(()=>{ document.getElementById('scrollWrap').scrollTop=toPx({y:1981,m:1})-60; });
</script>
</body>
</html>
